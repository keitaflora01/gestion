{% load static%}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - Budget Personnel</title>
    <link rel="stylesheet" href="{% static 'css/tableaubord.css' %}">
    <link rel="stylesheet" href="{% static 'css/objectif.css' %}">
    <link rel="stylesheet" href="{% static 'css/categoriedepense.css' %}">
    <link rel="stylesheet" href="{% static 'css/depenseform.css' %}">
    <link rel="stylesheet" href="{% static 'css/ajouterdepense.css' %}">
    <link rel="stylesheet" href ="{% static 'css/formulaireobjectif.css' %}">
    <link rel="stylesheet" href ="{% static 'css/rapport.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Style pour la date dans les messages */
        .message-timestamp {
            font-size: 0.8em;
            color: #888;
            margin-top: 2px;
            text-align: right;
        }
        
        /* Style pour s'assurer que les messages affichent correctement la date */
        .message {
            position: relative;
            padding-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        {% include "./includes/sidebar.html" %}
        <!-- Main Content -->
        <div class="main-content">
            {% block content %}
            {% include "./includes/navbar.html" %}

            
            <!-- Stats Row -->
            <div class="dashboard-grid">
                <div class="card card-sm">
                    <div class="stat-card">
                        <div class="stat-value">{{ chart_data.5.revenus|default:0 }} FCFA</div>
                        <div class="stat-label">Revenus du mois</div>
                    </div>
                </div>
                
                <div class="card card-sm">
                    <div class="stat-card">
                        <div class="stat-value">{{ chart_data.5.depenses|default:0 }} FCFA</div>
                        <div class="stat-label">Dépenses du mois</div>
                    </div>
                </div>
                
                <div class="card card-sm">
                    <div class="stat-card">
                        <div class="stat-value">{{ chart_data.5.revenus|default:0|add:chart_data.5.depenses|default:0 }} FCFA</div>
                        <div class="stat-label">Solde du mois</div>
                    </div>
                </div>
            </div>
            
            <!-- Graphique de comparaison revenus/dépenses -->
            <div class="dashboard-grid">
                <div class="card card-lg">
                    <div class="card-header">
                        <h2 class="card-title">Comparaison Revenus vs Dépenses</h2>
                        <div class="date-filter">
                            <label>Période:</label>
                            <select id="periodSelect" class="form-control">
                                <option value="6">6 derniers mois</option>
                                <option value="12">12 derniers mois</option>
                                <option value="3">3 derniers mois</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Analyse des tendances -->
            <div class="dashboard-grid">
                <div class="card card-lg">
                    <div class="card-header">
                        <h2 class="card-title">Analyse des tendances des dépenses</h2>
                        <div class="date-filter">
                            <label>Période:</label>
                            <select id="trendPeriod" class="form-control">
                                <option value="week">Cette semaine</option>
                                <option value="month" selected>Ce mois</option>
                                <option value="year">Cette année</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script>
    // Graphique de comparaison revenus/dépenses
    const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
    const comparisonChart = new Chart(comparisonCtx, {
        type: 'bar',
        data: {
            labels: {{ chart_data|safe }}.map(item => item.month),
            datasets: [
                {
                    label: 'Revenus',
                    data: {{ chart_data|safe }}.map(item => item.revenus),
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Dépenses',
                    data: {{ chart_data|safe }}.map(item => item.depenses),
                    backgroundColor: 'rgba(255, 99, 132, 0.7)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Montant (€)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Mois'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.raw + ' €';
                        }
                    }
                }
            }
        }
    });

    // Graphique d'analyse des tendances
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    const trendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: {{ trend_data|safe }}.map(item => item.week),
            datasets: [
                {
                    label: 'Dépenses',
                    data: {{ trend_data|safe }}.map(item => item.depenses),
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Montant (€)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Semaine'
                    }
                }
            }
        }
    });

    // Gestion du changement de période
    document.getElementById('periodSelect').addEventListener('change', function() {
        const months = parseInt(this.value);
        // Envoyer une requête AJAX pour récupérer les nouvelles données
        fetch(`/api/stats?months=${months}`)
            .then(response => response.json())
            .then(data => {
                comparisonChart.data.labels = data.map(item => item.month);
                comparisonChart.data.datasets[0].data = data.map(item => item.revenus);
                comparisonChart.data.datasets[1].data = data.map(item => item.depenses);
                comparisonChart.update();
            });
    });

    document.getElementById('trendPeriod').addEventListener('change', function() {
        const period = this.value;
        // Envoyer une requête AJAX pour récupérer les nouvelles données
        fetch(`/api/trends?period=${period}`)
            .then(response => response.json())
            .then(data => {
                trendChart.data.labels = data.labels;
                trendChart.data.datasets[0].data = data.values;
                trendChart.update();
            });
    });

    // Gestion du formulaire de support
document.querySelector('.support-form form').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = this;
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Votre message a été envoyé avec succès !');
            form.reset();
            // Rafraîchir la liste des messages
            location.reload();
        } else {
            alert('Une erreur est survenue. Veuillez réessayer.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Une erreur est survenue. Veuillez réessayer.');
    });
});
</script>
    {% endblock content %}
</body>
</html>